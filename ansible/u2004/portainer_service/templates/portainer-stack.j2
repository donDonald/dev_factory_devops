version: '3.2'



services:



    portainer:
        image: portainer/portainer-ce:{{ tag }}
#       command: -H tcp://tasks.agent:{{ src_port }} --tlsskipverify
        command: -H tcp://tasks.agent:9001 --tlsskipverify
        ports:
            - "{{ src_port }}:{{ dst_port }}"
            - "8000:8000"
        volumes:
            - portainer_data:/data
        networks:
            - {{ network_name }}
        deploy:
            mode: replicated
            replicas: 1
            placement:
                constraints: [node.role == manager]



    # https://www.portainer.io/documentation/how-to-use-the-agent/
    agent:
        image: portainer/agent:{{ tag }}
           #environment:
           #    AGENT_PORT: 9001
           #    LOG_LEVEL: debug
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock
            - /var/lib/docker/volumes:/var/lib/docker/volumes
        ports:
            - target: 9001
              published: 9001
              protocol: tcp
              mode: host
        networks:
            - {{ network_name }}
        deploy:
            mode: global
            placement:
              constraints: [node.platform.os == linux]



networks:
    {{ network_name }}:
        driver: overlay
        attachable: true



volumes:
    portainer_data:

