---

#https://portainer.readthedocs.io/en/stable/deployment.html#inside-a-swarm-cluster
#https://portainer.readthedocs.io/en/stable/agent.html

- name: Print out portainer info
  debug:
    msg:
     - "tag:{{ tag }}"
     - "src_port:{{ src_port }}"
     - "dst_port:{{ dst_port }}"
  tags: portainer



- name: Get info on Docker Swarm
  docker_swarm_info:
    api_version: '{{ docker.api_version }}'
# ignore_errors: yes
  register: swarm_info_2



- debug:
    msg:
      - "inventory_hostname:{{ inventory_hostname }}"
      - "network_name:{{ network_name }}"
      - "advertise_address:{{ advertise_address }}"
      - 'Docker in Swarm mode:{{ swarm_info_2.docker_swarm_active }}'
      - 'This is a Manager node:{{ swarm_info_2.docker_swarm_manager }}'
      - 'Manager token:{{ swarm_info_2.swarm_facts.JoinTokens.Manager }}'
      - 'Worker token:{{ swarm_info_2.swarm_facts.JoinTokens.Worker }}'
  tags: portainer



- name: Copy portainer deployment file
  template:
    src: 'portainer-stack.j2'
    dest: '/home/{{ user_name }}/portainer-stack.yml'
  tags: portainer

 

- name: Deploy portainer
  command: docker stack deploy --compose-file=/home/{{ user_name }}/portainer-stack.yml portainer
  tags: portainer

